name: æ›´æ–°clash

on:
  schedule:
    # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡ï¼ˆUTCæ—¶é—´ï¼‰
    - cron: '0 */6 * * *'
    workflow_dispatch:
jobs:
  update-clash:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
             
    - name: Download and update clash.yaml
      env:
        CLASH_SUBSCRIPTION_URL: ${{ secrets.CLASH_SUBSCRIPTION_URL }}
      run: |
        echo "Downloading Clash subscription..."
        
        # æ–¹æ³•1: ä½¿ç”¨curlä¸‹è½½å¹¶ç›´æ¥ä¿å­˜ä¸ºclash.yaml
        curl -L "$CLASH_SUBSCRIPTION_URL" -o dist/clash-temp.yaml
        
        # æ£€æŸ¥æ˜¯å¦ä¸‹è½½æˆåŠŸ
        if [ ! -s dist/clash-temp.yaml ]; then
          echo "Error: Downloaded file is empty!"
          exit 1
        fi
        
        echo "File downloaded. Size: $(wc -c < dist/clash-temp.yaml) bytes"
        
        # æ£€æŸ¥æ˜¯å¦æ˜¯Base64ç¼–ç ï¼ˆå¾ˆå¤šClashè®¢é˜…æ˜¯Base64ç¼–ç çš„ï¼‰
        # å¦‚æœæ–‡ä»¶å¼€å¤´ä¸æ˜¯YAMLçš„å…¸å‹ç»“æ„ï¼Œåˆ™å¯èƒ½æ˜¯Base64
        if ! head -n 1 dist/clash-temp.yaml | grep -q -E "^(proxies:|mixed-port:|port:|socks-port:)"; then
          echo "Detected Base64 encoded config, decoding..."
          base64 -d dist/clash-temp.yaml > dist/clash-temp2.yaml
          
          # éªŒè¯è§£ç åçš„æ–‡ä»¶
          if [ -s dist/clash-temp2.yaml ]; then
            mv dist/clash-temp2.yaml dist/clash-temp.yaml
            echo "Base64 decoded successfully"
          else
            echo "Warning: Base64 decoding may have failed, keeping original"
            rm -f dist/clash-temp2.yaml
          fi
        fi
        
        # å¤‡ä»½æ—§çš„é…ç½®æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
        if [ -f dist/clash.yaml ]; then
          cp dist/clash.yaml dist/clash.yaml.backup
          echo "Backup created: dist/clash.yaml.backup"
        fi
        
        # é‡å‘½åä¸ºæœ€ç»ˆçš„clash.yaml
        mv dist/clash-temp.yaml dist/clash.yaml
        
        # éªŒè¯æ–°æ–‡ä»¶
        if [ -s dist/clash.yaml ]; then
          echo "Successfully updated dist/clash.yaml"
          echo "New file size: $(wc -c < dist/clash.yaml) bytes"
          
          # å°è¯•æ£€æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆçš„YAMLï¼ˆéœ€è¦yqå·¥å…·ï¼‰
          if command -v yq > /dev/null 2>&1; then
            yq --version
            if yq e '.' dist/clash.yaml > /dev/null 2>&1; then
              echo "YAML syntax appears valid"
            else
              echo "Warning: YAML syntax check failed (may still be valid)"
            fi
          fi
        else
          echo "Error: Final file is empty!"
          exit 1
        fi
        
    - name: Install yq for YAML validation (å¯é€‰)
      if: always()
      run: |
        # å®‰è£…yqç”¨äºYAMLéªŒè¯ï¼ˆå¯é€‰æ­¥éª¤ï¼‰
        sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
        sudo chmod a+x /usr/local/bin/yq
        yq --version
        
    - name: Commit and push changes
      run: |
        # é…ç½®gitç”¨æˆ·
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # åªæ·»åŠ clash.yamlæ–‡ä»¶
        git add dist/clash.yaml
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        if git diff --staged --quiet; then
          echo "No changes to dist/clash.yaml"
        else
          # è·å–å½“å‰æ—¶é—´
          TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S')
          
          # æäº¤å¹¶æ¨é€
          git commit -m "ğŸ”„ Update clash.yaml [${TIMESTAMP}]"
          git push origin HEAD:${{ github.ref_name }}
          
          echo "Changes committed and pushed successfully"
        fi
