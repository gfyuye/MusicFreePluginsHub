name: 更新clash

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:
jobs:
  update-clash:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
             
    - name: Download and update clash.yaml
      env:
        CLASH_SUBSCRIPTION_URL: ${{ secrets.CLASH_SUBSCRIPTION_URL }}
      run: |
        echo "Downloading Clash subscription..."
        
        curl -L "$CLASH_SUBSCRIPTION_URL" -o dist/clash-temp.yaml
        
       
        if [ ! -s dist/clash-temp.yaml ]; then
          echo "Error: Downloaded file is empty!"
          exit 1
        fi
        
        echo "File downloaded. Size: $(wc -c < dist/clash-temp.yaml) bytes"
        

        if ! head -n 1 dist/clash-temp.yaml | grep -q -E "^(proxies:|mixed-port:|port:|socks-port:)"; then
          echo "Detected Base64 encoded config, decoding..."
          base64 -d dist/clash-temp.yaml > dist/clash-temp2.yaml
          
      
          if [ -s dist/clash-temp2.yaml ]; then
            mv dist/clash-temp2.yaml dist/clash-temp.yaml
            echo "Base64 decoded successfully"
          else
            echo "Warning: Base64 decoding may have failed, keeping original"
            rm -f dist/clash-temp2.yaml
          fi
        fi
        
     
        if [ -f dist/clash.yaml ]; then
          cp dist/clash.yaml dist/clash.yaml.backup
          echo "Backup created: dist/clash.yaml.backup"
        fi
        

        mv dist/clash-temp.yaml dist/clash.yaml
        
     
        if [ -s dist/clash.yaml ]; then
          echo "Successfully updated dist/clash.yaml"
          echo "New file size: $(wc -c < dist/clash.yaml) bytes"
          
         
          if command -v yq > /dev/null 2>&1; then
            yq --version
            if yq e '.' dist/clash.yaml > /dev/null 2>&1; then
              echo "YAML syntax appears valid"
            else
              echo "Warning: YAML syntax check failed (may still be valid)"
            fi
          fi
        else
          echo "Error: Final file is empty!"
          exit 1
        fi
        
    - name: Install yq for YAML validation (可选)
      if: always()
      run: |
     
        sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
        sudo chmod a+x /usr/local/bin/yq
        yq --version
        
    - name: Commit and push changes
      run: |
        git config user.name github-actions[bot]
        git config user.email github-actions[bot]@users.noreply.github.com
        git add dist/clash.yaml
        
        if git diff --staged --quiet; then
          echo "No changes to dist/clash.yaml"
        else
          git diff-index --quiet HEAD || git commit -m "chore: update clash.yaml"
          git push
        fi
